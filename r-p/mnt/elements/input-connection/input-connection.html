<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="input-connection">
<style is="custom-style" include="shared-styles"></style>
  <template>

  <style>
  :host {
    display: block;

    margin: 10px;
    @apply(--layout-vertical);
    @apply(--layout-center);
    @apply(layout-around-justified);
  }
  .invisible{
    display: none;
  }

  .title{
    margin-top: 20px;
    margin-bottom: 20px;
  }

  paper-fab{
    background-color: green;
    margin-top: 10px;
    margin-right: 10px;
  }
  </style>

  <iron-ajax
  id="mailsender"
  method="POST"
  content-type="application/json"
  handle-as="json"
  on-response="mailsent"
  last-response="{{dates}}"></iron-ajax>

  <iron-ajax
  id="mailverifier"
  method="POST"
  content-type="application/json"
  handle-as="json"
  on-response="verified"
  last-response="{{dates}}"></iron-ajax>
  <h3 class="title">
    Inseritre Email e verificarla
  </h3>


  <div class="layout horizontal">
    <paper-fab mini icon="add" on-tap="addmail"></paper-fab>
    <gold-email-input
    id="emailinput"
    auto-validate
    label="email"
    value="{{mail}}"
    required></gold-email-input>
  </div>
  <paper-button id="emailinputbutton" on-tap="sendmail" class="primary" raised>invia Email</paper-button>
  <paper-spinner-lite class="invisible" id="emailinputspinner"  active></paper-spinner-lite>


  <div class="layout horizontal">
    <paper-fab mini icon="add" on-tap="addpin"></paper-fab>
    <paper-input
    id="authcode"
    label="Codice Conferma"
    value="{{pin}}"
    char-counter maxlength="5"
    auto-validate pattern="[0-9]*"
    allowed-pattern="[0-9]"
    error-message="inserire un codice valido (5 numeri) "
    minlength="5"
    required
    ></paper-input>
  </div>
  <paper-button id="authcodebutton"on-tap="verify" class="primary" raised>Conferma</paper-button>
  <paper-spinner-lite class="invisible" id="authcodespinner"  active></paper-spinner-lite>


</template>
<script>
(function() {
  'use strict';

  Polymer({
    is: 'input-connection',
    behaviors: [MyBehaviors.Config],
    properties: {
      status: {
        type: Number,
        notify: true,
        observer: 'statusChange'
      },
      mail: {
        type: String,
        value: '',
        notify: true,
        observer: 'mailchange'
      },
      pin:{
        type: String,
        value: '',
        notify: true,
        observer: 'pinchange'
      }
    },

    mailchange:function(){
      if ( this.$.emailinput.validate() ){
        this.$.emailinputbutton.toggleAttribute('disabled', false);
      }else{this.$.emailinputbutton.toggleAttribute('disabled', true);}
    },

    pinchange:function(){
      if ( this.$.authcode.validate() ){
        this.$.authcodebutton.toggleAttribute('disabled', false);
      }else{this.$.authcodebutton.toggleAttribute('disabled', true);}
    },

    addmail: function(){
      this.mail = 'stefa@marchesi.com';
    },

    addpin: function(){
      this.pin = '16543';
    },
    statusChange: function(newValue) {
      switch (newValue) {
        case 1:
        this.$.emailinput.toggleAttribute('disabled', false);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleAttribute('disabled', true);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', true);
        this.$.emailinput.focus();
        break;

        case 2:
        this.$.emailinput.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputspinner.toggleClass('invisible', false);
        this.$.authcode.toggleAttribute('disabled', true);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', true);
        break;

        case 3:
        this.$.emailinput.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleAttribute('disabled', false);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', true);
        this.$.authcode.focus();
        break;

        case 4:
        this.$.emailinput.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleAttribute('disabled', true);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', false);
        break;

        default:
        this.$.emailinput.toggleAttribute('disabled', false);
        this.$.emailinputbutton.toggleAttribute('disabled', false);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleAttribute('disabled', true);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', true);
      }
    },
    verify:function(){
      this.$.mailverifier.body={mail: this.mail, pin: this.pin};
      this.$.mailverifier.generateRequest();
      this.status=4;
    },

    verified:function(){
      this.status=10;
    },
    attached: function(){
      this.$.mailsender.url=this.baseUrl+':3000/internal/sendmail';
      this.$.mailverifier.url=this.baseUrl+':3000/internal/verifymail';
    },
    sendmail:function(){
      this.$.mailsender.body={mail: this.mail};
      this.$.mailsender.generateRequest();
      this.status=2;
    },
    mailsent:function(){
      this.status=3;
    }
  });
})();
</script>
</dom-module>
