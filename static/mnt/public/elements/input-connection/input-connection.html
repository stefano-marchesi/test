<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="input-connection">
  <style is="custom-style" include="shared-styles"></style>
  <template>

  <style>
  :host {
    display: block;
    margin: 10px;
    @apply(--layout-vertical);
    @apply(--layout-center);
    @apply(layout-around-justified);
  }
  .invisible{
    display: none;
  }

  paper-spinner-lite {
    margin: 15px;
  }

.ref{
@apply(--layout-self-center);
margin-left: 5px;
}

  #emailinput{
    min-width: 250px;
    margin-bottom: 30px;
  }

  #title{
    margin-top: 50px;
    margin-bottom: 20px;
  }

  #authcode{
    margin-bottom: 30px;
  }



  </style>

  <iron-ajax
  id="mailsender"
  method="POST"
  content-type="application/json"
  handle-as="json"
  on-response="mailsent"
  last-response="{{dates}}"></iron-ajax>

  <iron-ajax
  id="mailverifier"
  method="POST"
  content-type="application/json"
  handle-as="json"
  on-response="verified"
  last-response="{{dates}}"></iron-ajax>


  <h3 id="title">
    Inserire E-mail
  </h3>


  <div class=" email layout horizontal">


    <gold-email-input
    id="emailinput"
    auto-validate
    label="email"
    value="{{mail}}"
    required></gold-email-input>

    <div class="ref">

      <paper-icon-button id="refresh" icon="refresh" on-tap="refresh" ></paper-icon-button>
    </div>
  </div>
  <paper-button id="emailinputbutton" on-tap="sendmail" class="primary" raised> <iron-icon icon="drafts"></iron-icon>invia Email</paper-button>
  <paper-spinner-lite class="invisible" id="emailinputspinner"  active></paper-spinner-lite>



  <div class="layout horizontal">


    <paper-input
    id="authcode"
    label="Codice Conferma"
    value="{{pin}}"
    char-counter maxlength="4"
    auto-validate pattern="[0-9]*"
    allowed-pattern="[0-9]"
    minlength="4"
    required
    ></paper-input>
  </div>
  <paper-button id="authcodebutton"on-tap="verify" class="primary" raised>Conferma</paper-button>
  <paper-spinner-lite class="invisible" id="authcodespinner"  active></paper-spinner-lite>


</template>
<script>
(function() {
  'use strict';

  Polymer({
    is: 'input-connection',
    behaviors: [MyBehaviors.Config],
    properties: {
      status: {
        type: Number,
        notify: true,
        observer: 'statusChange'
      },
      mail: {
        type: String,
        value: '',
        notify: true,
        observer: 'mailchange'
      },
      pin:{
        type: String,
        value: '',
        notify: true,
        observer: 'pinchange'
      }
    },

    refresh: function(){
      this.mail= '';
      this.status = 1;
    },

    mailchange:function(){
      if ( this.$.emailinput.validate() ){
        this.$.emailinputbutton.toggleAttribute('disabled', false);
      }else{this.$.emailinputbutton.toggleAttribute('disabled', true);}
    },

    pinchange:function(){
      if ( this.$.authcode.validate() ){
        this.$.authcodebutton.toggleAttribute('disabled', false);
      }else{this.$.authcodebutton.toggleAttribute('disabled', true);}
    },

    verify:function(){
      if (this.dates.verifycationcode == this.pin) {
        this.status=10;
      }else{
        this.pin='';
      }
    },

    verified:function(){
      this.status=10;
    },
    attached: function(){
      this.$.mailsender.url=this.baseUrl+':3000/internal/sendmail';
      this.$.mailverifier.url=this.baseUrl+':3000/internal/verifymail';
    },
    sendmail:function(){
      this.$.mailsender.body={mail: this.mail};
      this.$.mailsender.generateRequest();
      this.status=2;
    },
    mailsent:function(){
      this.status=3;
      console.log(this.dates);
    },


    statusChange: function(newValue) {
      switch (newValue) {
        case 1:
        this.$.title.innerHTML="Inserire email"
        this.$.emailinput.toggleAttribute('disabled', false);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleClass('invisible', false);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.emailinput.focus();
        this.$.authcode.toggleClass('invisible', true);
        this.$.authcodebutton.toggleClass('invisible', true);
        this.$.authcodespinner.toggleClass('invisible', true);
        this.$.refresh.toggleClass('invisible', true);
        break;

        case 2:
        this.$.title.innerHTML=""
        this.$.emailinput.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputspinner.toggleClass('invisible', false);
        this.$.authcode.toggleClass('invisible', true);
        this.$.authcodebutton.toggleClass('invisible', true);
        this.$.authcodespinner.toggleClass('invisible', true);
        this.$.refresh.toggleClass('invisible', true);
        break;

        case 3:
        this.$.title.innerHTML="Inserire codice di verifica"
        this.$.emailinput.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleClass('invisible', true);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleClass('invisible', false);
        this.$.authcodebutton.toggleClass('invisible', false);
        this.$.authcodespinner.toggleClass('invisible', true);
        this.$.refresh.toggleClass('invisible', false);
        this.$.authcode.focus();
        break;

        case 4:

        this.$.emailinput.toggleAttribute('disabled', true);
        this.$.emailinputbutton.toggleAttribute('disabled', true);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleClass('invisible', false);
        this.$.authcodebutton.toggleClass('invisible', false);
        this.$.authcode.toggleAttribute('disabled', true);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', false);
              this.$.refresh.toggleClass('invisible', true);
        break;

        default:
        this.$.emailinput.toggleAttribute('disabled', false);
        this.$.emailinputbutton.toggleAttribute('disabled', false);
        this.$.emailinputspinner.toggleClass('invisible', true);
        this.$.authcode.toggleAttribute('disabled', true);
        this.$.authcodebutton.toggleAttribute('disabled', true);
        this.$.authcodespinner.toggleClass('invisible', true);
      }
    }
  });
})();
</script>
</dom-module>
